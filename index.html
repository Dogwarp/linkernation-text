<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>リンカーネイション（完全版・AI物語生成対応）</title>
<style>
  body { font-family: "Yu Gothic", sans-serif; background-color: #fdf6e3; color: #333; line-height: 1.6; padding: 20px; }
  h1,h2 { color: #b58900; }
  pre { background-color: #eee8d5; padding: 10px; border-radius: 5px; overflow-x: auto; }
  button, select, input { margin: 5px; padding: 5px 10px; }
  .hand { margin-bottom: 10px; }
</style>
</head>
<body>

<h1>リンカーネイション（完全版・AI物語生成対応）</h1>

<section>
<h2>プレイヤー: Dogwarp</h2>
<div class="hand" id="playerHand"></div>
<label>役のカードを選択（番号カンマ区切り）:</label>
<input type="text" id="playerCards" placeholder="例: 3,16,32">
<br>
<label>物語:</label>
<input type="text" id="playerStory" placeholder="ここに物語を入力">
<br>
<label>駆け引き:</label>
<select id="playerMove">
  <option value="なし">なし</option>
  <option value="取引">運命の取引</option>
  <option value="強奪">運命の強奪</option>
</select>
<label>対象AI:</label>
<select id="targetAI">
  <option value="0">AI_アルタ</option>
  <option value="1">AI_ベラ</option>
</select>
<br>
<button onclick="playTurn()">ターン実行</button>
</section>

<section>
<h2>プレイログ</h2>
<pre id="log"></pre>
</section>

<script>
// カードデータ
const rnmCards = Array.from({length:36},(_,i)=>i+1);
const rnmNames = ["騎士","クローバー","船","家","木","雲","蛇","棺","花束","鎌","鞭","鳥","子供","狐","熊","星","コウノトリ","犬","塔","庭園","山","道","ネズミ","ハート","指輪","本","手紙","紳士","淑女","百合","太陽","月","鍵","魚","錨","十字架"];
const tarotNames = ["愚者","魔術師","女教皇","女帝","皇帝","教皇","恋人","戦車","力","隠者","運命の輪","正義","吊るされた男","死神","節制","悪魔","塔","星","月","太陽","審判","世界"];

// ゲーム状態
let playerHand = [], aiHands = [], playerFragments = 0, aiFragments = [0,0];
let deck = [...rnmCards], turn = 0, logEl = document.getElementById("log");
const aiNames = ["AI_アルタ","AI_ベラ"];

// 山札シャッフル
function shuffle(array){ return array.sort(()=>Math.random()-0.5); }
deck = shuffle(deck);

// 初期手札
function draw(n){ return deck.splice(0,n); }
playerHand = draw(5);
aiHands = [draw(5), draw(5)];
document.getElementById("playerHand").innerText = "手札: " + playerHand.map(i=>rnmNames[i-1]).join(", ");

// 初期世界情勢カード
let currentWorldCard = tarotNames[Math.floor(Math.random()*tarotNames.length)];
logEl.textContent += `--- ゲーム開始 ---\n`;
logEl.textContent += `世界情勢: 【${currentWorldCard}】\n`;

// カード名取得
function cardName(i){ return rnmNames[i-1]; }

// AI物語生成（ブラウザ完結版）
function generateAIStory(aiName, aiCards, worldCard) {
  const actions = ["冒険した","探索した","守護した","挑戦した","発見した"];
  const adjectives = ["神秘的な","危険な","輝かしい","孤独な","不思議な"];
  const items = ["秘宝","鍵","光","力","希望"];
  const cardStr = aiCards.map(i=>cardName(i)).join("＋");
  const action = actions[Math.floor(Math.random()*actions.length)];
  const adj = adjectives[Math.floor(Math.random()*adjectives.length)];
  const item = items[Math.floor(Math.random()*items.length)];
  return `${aiName}は【${cardStr}】で${adj}${item}を${action}。世界情勢【${worldCard}】に導かれ、新たな可能性を切り開いた。`;
}

// ターン実行
function playTurn(){
  if(deck.length===0 && playerHand.length===0 && aiHands.every(h=>h.length===0)){
    logEl.textContent += `--- 山札が尽きました ---\n`;
    let all = [playerFragments,...aiFragments];
    let winnerIdx = all.indexOf(Math.max(...all));
    let winnerName = winnerIdx===0?"Dogwarp":aiNames[winnerIdx-1];
    logEl.textContent += `勝者は ${winnerName} です！\n`;
    return;
  }

  // 現在の世界情勢を表示・ログに残す
  logEl.textContent += `--- ターン ${turn+1} ---\n`;
  logEl.textContent += `世界情勢: 【${currentWorldCard}】\n`;

  // プレイヤー入力
  const cardInput = document.getElementById("playerCards").value.split(",").map(x=>parseInt(x.trim())).filter(x=>playerHand.includes(x));
  const story = document.getElementById("playerStory").value || "物語なし";
  const pc = cardInput.map(i=>cardName(i));
  const playerCreativity = Math.floor(Math.random()*6);
  const playerPersuasion = Math.floor(Math.random()*4);
  const playerFit = Math.floor(Math.random()*3);
  const playerPoint = playerCreativity + playerPersuasion + playerFit;
  playerFragments += playerPoint;
  // 手札からカード削除し補充
  playerHand = playerHand.filter(c=>!cardInput.includes(c));
  playerHand = playerHand.concat(draw(Math.min(cardInput.length, deck.length)));
  document.getElementById("playerHand").innerText = "手札: " + playerHand.map(i=>cardName(i)).join(", ");

  logEl.textContent += `Dogwarp: 役【${pc.join("＋")}】\n`;
  logEl.textContent += `物語: ${story}\n`;
  logEl.textContent += `得点: 創造性${playerCreativity}点、説得力${playerPersuasion}点、適合性${playerFit}点\n`;
  logEl.textContent += `運命の欠片: ${playerFragments}枚\n\n`;

  // AIターン
  aiHands.forEach((hand,idx)=>{
    if(hand.length===0) return;
    const aiCardCount = Math.min(hand.length,Math.floor(Math.random()*3)+1);
    let tmp = hand.slice(), aiCards=[];
    for(let i=0;i<aiCardCount;i++){ aiCards.push(tmp.splice(Math.floor(Math.random()*tmp.length),1)[0]); }
    aiHands[idx] = hand.filter(c=>!aiCards.includes(c));
    aiHands[idx] = aiHands[idx].concat(draw(Math.min(aiCardCount, deck.length)));

    const aiStory = generateAIStory(aiNames[idx], aiCards, currentWorldCard);
    const aiCreativity = Math.floor(Math.random()*6);
    const aiPersuasion = Math.floor(Math.random()*4);
    const aiFit = Math.floor(Math.random()*3);
    const aiPoint = aiCreativity + aiPersuasion + aiFit;
    aiFragments[idx] += aiPoint;

    logEl.textContent += `${aiNames[idx]}: 役【${aiCards.map(i=>cardName(i)).join("＋")}】\n`;
    logEl.textContent += `物語: ${aiStory}\n`;
    logEl.textContent += `得点: 創造性${aiCreativity}点、説得力${aiPersuasion}点、適合性${aiFit}点\n`;
    logEl.textContent += `運命の欠片: ${aiFragments[idx]}枚\n`;

    // AI駆け引き（ランダム）
    let move="なし";
    if(aiFragments[idx]<Math.max(playerFragments,...aiFragments)) move=(Math.random()<0.5)?"取引":"強奪";
    if(move!=="なし"){
      let target=0; if(Math.random()<0.3) target=1-idx;
      let success=Math.random() < ((move==="強奪")?0.5:0.6);
      if(success && ((target===0 && playerFragments>0)||(target!==0 && aiFragments[target]>0))){
        if(target===0) playerFragments--; else aiFragments[target]--;
        aiFragments[idx]++;
        logEl.textContent += `${aiNames[idx]}は${target===0?"Dogwarp":aiNames[target]}に運命の${move}成功！\n`;
      } else { if(aiFragments[idx]>0) aiFragments[idx]--; logEl.textContent += `${aiNames[idx]}の運命の${move}失敗…1欠片減少\n`; }
    }
    logEl.textContent += "\n";
  });

  // プレイヤー駆け引き
  const move = document.getElementById("playerMove").value;
  const target = parseInt(document.getElementById("targetAI").value);
  if(move!=="なし"){
    let success=Math.random() < ((move==="強奪")?0.5:0.6);
    if(success && aiFragments[target]>0){ aiFragments[target]--; playerFragments++; logEl.textContent += `駆け引き成功！Dogwarpは${aiNames[target]}から欠片1枚獲得。\n\n`; }
    else{ if(playerFragments>0) playerFragments--; logEl.textContent += `駆け引き失敗…Dogwarpの欠片1枚減少。\n\n`; }
  }

  // 次の世界情勢をランダム更新
  currentWorldCard = tarotNames[Math.floor(Math.random()*tarotNames.length)];
  turn++;
  logEl.scrollTop = logEl.scrollHeight;
}
</script>

</body>
</html>
