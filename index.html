<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒªãƒ³ã‚«ãƒ¼ãƒã‚¤ã‚·ãƒ§ãƒ³ å³èˆˆå°èª¬ãƒ‡ãƒ¢ v2</title>
<style>
  body { font-family: "Yu Gothic", sans-serif; background-color: #fdf6e3; padding: 20px; }
  h1 { color: #b58900; }
  .story { border:1px solid #ccc; margin-bottom:10px; padding:10px; }
  .story-title { font-weight:bold; }
  .cards, .hand { margin:5px 0; }
  button { margin:2px; }
</style>
</head>
<body>
<h1>ãƒªãƒ³ã‚«ãƒ¼ãƒã‚¤ã‚·ãƒ§ãƒ³ å³èˆˆå°èª¬ãƒ‡ãƒ¢ v2</h1>

<div>
  <button onclick="startNewStory()">æ–°ã‚¹ãƒ¬ãƒƒãƒ‰ä½œæˆ</button>
</div>

<div id="stories"></div>

<div id="handContainer" style="display:none;">
  <div>å¤§ã‚¢ãƒ«ã‚«ãƒŠãŠé¡Œ: <span id="majorCards"></span></div>
  <div class="hand">æ‰‹æœ­: <span id="handCards"></span></div>
  <textarea id="storyInput" rows="2" cols="50" placeholder="ã“ã“ã«ç¶šãã®æ–‡ç« ã‚’æ›¸ãã¾ã™ï¼ˆ1åˆ†ä»¥å†…ï¼‰"></textarea><br>
  <button onclick="submitStory()">æŠ•ç¨¿</button>
  <button onclick="skipTurn()">é™å‚ï¼ã‚¹ã‚­ãƒƒãƒ—</button>
  <div>æ®‹ã‚Šæ™‚é–“: <span id="timer">60</span>ç§’</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
// Firebase åˆæœŸåŒ–
const firebaseConfig = {
  apiKey: "AIzaSyDdLmTIEgU3WNEN0Pr4fFNpQKjcYsmUXU8",
  authDomain: "linkernation-online.firebaseapp.com",
  projectId: "linkernation-online",
  storageBucket: "linkernation-online.appspot.com",
  messagingSenderId: "398889265909",
  appId: "1:398889265909:web:33f569fc04e98350d6b3bc",
  measurementId: "G-BH272B3F45"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let hand = [];
let majorHand = [];
let currentStoryId = null;
let timerInterval = null;
let timeLeft = 60;

const majorArcana = ["æ„šè€…","é­”è¡“å¸«","å¥³æ•™çš‡","å¥³å¸","çš‡å¸","æ•™çš‡","æ‹äºº","æˆ¦è»Š","åŠ›","éš è€…","é‹å‘½ã®è¼ª","æ­£ç¾©","åŠã‚‹ã•ã‚ŒãŸç”·","æ­»ç¥","ç¯€åˆ¶","æ‚ªé­”","å¡”","æ˜Ÿ","æœˆ","å¤ªé™½","å¯©åˆ¤","ä¸–ç•Œ"];
const minorArcana = ["é¨å£«","ã‚¯ãƒ­ãƒ¼ãƒãƒ¼","èˆ¹","å®¶","æœ¨","é›²","è›‡","æ£º","èŠ±æŸ","éŒ","é­","é³¥","å­ä¾›","ç‹","ç†Š","æ˜Ÿ","ã‚³ã‚¦ãƒãƒˆãƒª","çŠ¬","å¡”","åº­åœ’","å±±","é“","ãƒã‚ºãƒŸ","ãƒãƒ¼ãƒˆ","æŒ‡è¼ª","æœ¬","æ‰‹ç´™","ç´³å£«","æ·‘å¥³","ç™¾åˆ","å¤ªé™½","æœˆ","éµ","é­š","éŒ¨","åå­—æ¶"];

function startNewStory(){
  const title = prompt("ã‚¹ãƒ¬ãƒƒãƒ‰ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  if(!title) return;

  currentStoryId = db.ref('stories').push().key;
  hand = pickCards(5);
  majorHand = pickMajor(3);

  db.ref('stories/'+currentStoryId).set({
    title: title,
    cards: hand,
    major: majorHand,
    votes: 0,
    contents: []
  });

  document.getElementById("handContainer").style.display = "block";
  document.getElementById("handCards").innerText = hand.join(", ");
  document.getElementById("majorCards").innerText = majorHand.join(", ");
  startTimer();
  renderStories();
}

function pickCards(n){
  let arr = [];
  for(let i=0;i<n;i++){
    arr.push(minorArcana[Math.floor(Math.random()*minorArcana.length)]);
  }
  return arr;
}

function pickMajor(n){
  let arr = [];
  let copy = [...majorArcana];
  for(let i=0;i<n;i++){
    const idx = Math.floor(Math.random()*copy.length);
    arr.push(copy[idx]);
    copy.splice(idx,1);
  }
  return arr;
}

function submitStory(){
  const text = document.getElementById("storyInput").value;
  if(!text) return alert("1æ–‡å­—ä»¥ä¸Šæ›¸ã„ã¦ãã ã•ã„");
  const newPost = {
    text: text,
    votes: 0,
    timestamp: Date.now()
  };
  db.ref('stories/'+currentStoryId+'/contents').push(newPost);
  stopTimer();
  document.getElementById("storyInput").value = "";
  document.getElementById("handContainer").style.display = "none";
  renderStories();
}

function skipTurn(){
  stopTimer();
  document.getElementById("storyInput").value = "";
  document.getElementById("handContainer").style.display = "none";
}

function startTimer(){
  timeLeft = 60;
  document.getElementById("timer").innerText = timeLeft;
  timerInterval = setInterval(()=>{
    timeLeft--;
    document.getElementById("timer").innerText = timeLeft;
    if(timeLeft<=0){
      stopTimer();
      alert("æ™‚é–“åˆ‡ã‚Œã§ã™ï¼");
      skipTurn();
    }
  },1000);
}

function stopTimer(){
  clearInterval(timerInterval);
}

function vote(storyId, contentId){
  const ref = db.ref(`stories/${storyId}/contents/${contentId}/votes`);
  ref.transaction(v => (v||0)+1);
}

function renderStories(){
  db.ref('stories').once('value',snapshot=>{
    const storiesDiv = document.getElementById("stories");
    storiesDiv.innerHTML = "";
    const stories = snapshot.val();
    if(!stories) return;

    // äººæ°—é †ã«ã‚½ãƒ¼ãƒˆ
    const sorted = Object.entries(stories).sort((a,b)=>b[1].votes - a[1].votes);
    sorted.forEach(([id,story])=>{
      const div = document.createElement("div");
      div.className = "story";
      div.innerHTML = `<div class="story-title">${story.title} [æ‰‹æœ­: ${story.cards.join(", ")}] [ãŠé¡Œ: ${story.major.join(", ")}]</div>`;
      
      const contents = Object.entries(story.contents||{}).sort((a,b)=>b[1].votes - a[1].votes);
      contents.forEach(([cid,c])=>{
        const p = document.createElement("p");
        p.innerText = c.text + ` (ã„ã„ã­: ${c.votes||0})`;
        const voteBtn = document.createElement("button");
        voteBtn.innerText = "ğŸ‘";
        voteBtn.onclick = ()=>vote(id,cid);
        p.appendChild(voteBtn);
        div.appendChild(p);
      });

      storiesDiv.appendChild(div);
    });
  });
}

renderStories();
</script>
</body>
</html>
