<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>リンカーネイション 即興ストーリー</title>
<style>
  body { font-family: "Yu Gothic", sans-serif; background-color: #fdf6e3; color: #333; padding: 20px; }
  h1 { color: #b58900; }
  .story { border-bottom: 1px solid #ccc; padding: 5px; margin-bottom: 5px; }
  .hand { margin: 10px 0; }
  button { margin-left: 5px; }
</style>
</head>
<body>

<h1>リンカーネイション 即興ストーリー</h1>

<div class="hand">
  <strong>手札（お題）:</strong> 
  <span id="cards">---</span>
</div>

<div>
  <textarea id="storyInput" rows="2" cols="50" placeholder="1分以内に書き込もう"></textarea>
  <button id="submitBtn">投稿</button>
  <button id="pauseBtn">観戦モード</button>
</div>

<div>残り時間: <span id="timer">60</span> 秒</div>

<h2>投稿一覧（人気順）</h2>
<div id="storyList"></div>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-app.js";
  import { getDatabase, ref, push, onValue, update } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDdLmTIEgU3WNEN0Pr4fFNpQKjcYsmUXU8",
    authDomain: "linkernation-online.firebaseapp.com",
    databaseURL: "https://linkernation-online-default-rtdb.firebaseio.com/",
    projectId: "linkernation-online",
    storageBucket: "linkernation-online.appspot.com",
    messagingSenderId: "398889265909",
    appId: "1:398889265909:web:33f569fc04e98350d6b3bc",
    measurementId: "G-BH272B3F45"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const cardsList = ["愚者","魔術師","女教皇","女帝","皇帝","教皇","恋人","戦車","力","隠者","運命の輪","正義","吊るされた男","死神","節制","悪魔","塔","星","月","太陽","審判","世界"];
  
  let hand = [];
  let timeLeft = 60;
  let paused = false;
  let timerInterval;

  function drawHand() {
    hand = [];
    let copy = [...cardsList];
    for(let i=0;i<3;i++){
      const idx = Math.floor(Math.random()*copy.length);
      hand.push(copy[idx]);
      copy.splice(idx,1);
    }
    document.getElementById("cards").textContent = hand.join(" | ");
  }

  function startTimer() {
    clearInterval(timerInterval);
    timeLeft = 60;
    document.getElementById("timer").textContent = timeLeft;
    timerInterval = setInterval(()=>{
      if(!paused){
        timeLeft--;
        document.getElementById("timer").textContent = timeLeft;
        if(timeLeft<=0){ clearInterval(timerInterval); }
      }
    },1000);
  }

  document.getElementById("submitBtn").addEventListener("click",()=>{
    if(timeLeft<=0) return;
    const text = document.getElementById("storyInput").value.trim();
    if(text.length===0) return;
    push(ref(db,'stories'),{
      text,
      hand,
      likes:0,
      timestamp:Date.now()
    });
    document.getElementById("storyInput").value='';
    drawHand();
    startTimer();
  });

  document.getElementById("pauseBtn").addEventListener("click",()=>{
    paused = !paused;
    document.getElementById("pauseBtn").textContent = paused ? "投稿再開" : "観戦モード";
  });

  function renderStories(data){
    const container = document.getElementById("storyList");
    container.innerHTML='';
    const stories = Object.entries(data)
      .sort((a,b)=> b[1].likes - a[1].likes); // 人気順
    for(const [key,story] of stories){
      const div = document.createElement("div");
      div.className='story';
      div.innerHTML = `<strong>${story.hand.join(" | ")}</strong>: ${story.text} <button onclick="like('${key}')">いいね(${story.likes})</button>`;
      container.appendChild(div);
    }
  }

  window.like = function(key){
    const storyRef = ref(db,'stories/'+key);
    update(storyRef,{ likes: Date.now() }); // 仮で timestamp更新で簡易評価
  }

  onValue(ref(db,'stories'),(snapshot)=>{
    const data = snapshot.val() || {};
    renderStories(data);
  });

  // 初期手札・タイマー開始
  drawHand();
  startTimer();

</script>
</body>
</html>
